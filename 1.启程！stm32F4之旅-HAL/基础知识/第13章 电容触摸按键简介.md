# 第十三章 电容触摸按键简介

触摸按键相对于传统的机械按键有寿命长、占用空间少、易于操作等诸多优点。大家看看如今的手机，触摸屏、触摸按键大行其道，而传统的机械按键，正在逐步从手机上面消失。本章，我们将给大家介绍一种简单的触摸按键：电容式触摸按键。

我们将利用探索者 STM32F4 开发板上的触摸按键（TPAD），来实现对 DS1 的亮灭控制。这里 TPAD 其实就是探索者 STM32F4 开发板上的一小块覆铜区域，实现原理如图

![屏幕截图 2024 09 18 083049](https://img.picgo.net/2024/09/18/-2024-09-18-083049ab38d6060c965faf.png)

这里我们使用的是检测电容充放电时间的方法来判断是否有触摸， 图中 R 是外接的电容充电电阻， Cs 是没有触摸按下时 TPAD 与 PCB 之间的杂散电容。 而 Cx 则是有手指按下的时候，手指与 TPAD 之间形成的电容。图中的开关是电容放电开关（由实际使用时，由 STM32F4 的IO 代替）。

先用开关将 Cs（或 Cs+Cx）上的电放尽，然后断开开关，让 R 给 Cs（或 Cs+Cx）充电，当没有手指触摸的时候， Cs 的充电曲线如图中的 A 曲线。 而当有手指触摸的时候， 手指和 TPAD之间引入了新的电容 Cx，此时 Cs+Cx 的充电曲线如图中的 B 曲线。 从上图可以看出， A、 B两种情况下， Vc 达到 Vth 的时间分别为 Tcs 和 Tcs+Tcx。

其中， 除了 Cs 和 Cx 我们需要计算，其他都是已知的，根据电容充放电公式：

![屏幕截图 2024 09 18 083221](https://img.picgo.net/2024/09/18/-2024-09-18-08322163e9da447067fc21.png)

其中 Vc 为电容电压， V0 为充电电压， R 为充电电阻， C 为电容容值， e 为自然底数， t 为充电时间。根据这个公式，我们就可以计算出 Cs 和 Cx。 利用这个公式，我们还可以把探索者开发板作为一个简单的电容计，直接可以测电容容量了

在本章中，其实我们只要能够区分 Tcs 和 Tcs+Tcx，就已经可以实现触摸检测了，当充电时间在 Tcs 附近，就可以认为没有触摸，而当充电时间大于 Tcs+Tx 时，就认为有触摸按下（Tx为检测阀值）。

本章，我们使用 PA5(TIM2_CH1)来检测 TPAD 是否有触摸，在每次检测之前，我们先配置PA5 为推挽输出，将电容 Cs（或 Cs+Cx）放电，然后配置 PA5 为浮空输入，利用外部上拉电阻给电容 Cs(Cs+Cx)充电，同时开启 TIM2_CH1 的输入捕获，检测上升沿，当检测到上升沿的时候，就认为电容充电完成了，完成一次捕获检测。

在 MCU 每次复位重启的时候，我们执行一次捕获检测（可以认为没触摸），记录此时的值，记为 tpad_default_val，作为判断的依据。在后续的捕获检测，我们就通过与 tpad_default_val 的对比，来判断是不是有触摸发生。

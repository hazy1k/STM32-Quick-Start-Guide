# 第八章 STM32F4独立看门狗简介

## 1. 导入

STM32F4 的独立看门狗由内部专门的 32Khz 低速时钟（LSI） 驱动，即使主时钟发生故障，它也仍然有效。这里需要注意独立看门狗的时钟是一个内部 RC 时钟，所以并不是准确的 32Khz，而是在 15~47Khz 之间的一个可变化的时钟，只是我们在估算的时候，以 32Khz 的频率来计算，看门狗对时间的要求不是很精确，所以，时钟有些偏差，都是可以接受的。

## 2. 相关寄存器讲解

独立看门狗有几个寄存器与我们这节相关，我们分别介绍这几个寄存器：

### 2.1 关键字寄存器IWDG_KR

![屏幕截图 2024 09 12 110815](https://img.picgo.net/2024/09/12/-2024-09-12-11081588f6077341d16a30.png)

在关键字寄存器(IWDG_KR)中写入 0xCCCC，开始启用独立看门狗；此时计数器开始从其复位值 0xFFF 递减计数。当计数器计数到末尾 0x000 时，会产生一个复位信号(IWDG_RESET)。无论何时，只要关键字寄存器 IWDG_KR 中被写入 0xAAAA， IWDG_RLR 中的值就会被重新加载到计数器中从而避免产生看门狗复位 。

IWDG_PR 和 IWDG_RLR 寄存器具有写保护功能。要修改这两个寄存器的值，必须先向IWDG_KR 寄存器中写入 0x5555。 将其他值写入这个寄存器将会打乱操作顺序，寄存器将重新被保护。重装载操作(即写入 0xAAAA)也会启动写保护功能。

### 2.2 预分频寄存器（IWDG_PR）

接下来，我们介绍预分频寄存器（IWDG_PR），该寄存器用来设置看门狗时钟的分频系数，最低为 4，最高位 256，该寄存器是一个 32 位的寄存器，但是我们只用了最低 3 位，其他都是保留位。

![屏幕截图 2024 09 12 111143](https://img.picgo.net/2024/09/12/-2024-09-12-111143ce4f43fa051c443b.png)

### 2.3 重载寄存器IWDG_RLR

在介绍完 IWDG_PR 之后，我们介绍一下重装载寄存器 IWDG_RLR。该寄存器用来保存重装载到计数器中的值。该寄存器也是一个 32 位寄存器，但是只有低 12 位是有效的。

![屏幕截图 2024 09 12 111244](https://img.picgo.net/2024/09/12/-2024-09-12-1112447f5f11873e0e6e7a.png)

只要对以上三个寄存器进行相应的设置，我们就可以启动 STM32F4 的独立看门狗。独立看门狗相关 的库函数操作函数在文件 stm32f4xx_hal_iwdg.c 和对应的头文件stm32f4xx_hal_iwdg.h 中。

## 3. 库函数配置独立看门狗步骤

### 3.1 取消寄存器写保护（向IWDG_KR写入0x5555）

首先我们必须取消 IWDG_PR 和 IWDG_RLR 寄存器的写保护， 这样才可以设置寄存器IWDG_PR 和 IWDG_RLR 的值。 取消写保护和设置预分频系数以及重装载值在 HAL 库中是通过函数 HAL_IWDG_Init 实现的。该函数声明为：

```c
HAL_StatusTypeDef HAL_IWDG_Init(IWDG_HandleTypeDef *hiwdg);
```

该函数只有一个入口参数 hiwdg，该参数是 IWDG_HandleTypeDef 结构体指针类型。接下来我们看看结构体 IWDG_HandleTypeDef 定义：

```c
typedef struct
{
    IWDG_TypeDef *Instance;
    IWDG_InitTypeDef Init;
    HAL_LockTypeDef Lock;
    __IO HAL_IWDG_StateTypeDef State;
}IWDG_HandleTypeDef;
```

成员变量 Instance 用来设置看门狗寄存器基地址，实际上在 HAL 库中已经通过标识符定义了，这里对于独立看门狗直接设置为标识符 IWDG 即可。

成员变量 Init 是一个 IWDG_InitTypeDef 结构体类型，该结构体只有 2 个成员变量，分别用来设置独立看门狗的预分频系数和重装载值，定义如下：

```c
typedef struct
{
    uint32_t Prescaler;
    uint32_t Reload;
}IWDG_InitTypeDef
```

成员变量 Lock 是一个锁存变量，该变量在 HAL 库中当操作配置 IWDG 之前设置为锁住LOCK，当配置操作完成之后设置为 UNLOCK，实际上是一个操作状态标识符。

成员变量 State 也是 HAL 定义的一个过程标识符，用来记录 IWDG 处理状态。HAL_IWDG_Init 函数使用的一般方法为：

```c
IWDG_HandleTypeDef IWDG_Handler; // 独立看门狗句柄
IWDG_Handler.Instance = IWDG;    // 独立看门狗
IWDG_Handler.Init.Prescaler = IWDG_PRESCALER_64; // 设置 IWDG 分频系数
IWDG_Handler.Init.Reload = 500;  //重装载值
HAL_IWDG_Init(&IWDG_Handler);
```

上面程序的作用是初始化 IWDG，设置分频系数为 64，重装载值为 500。设置完预分频系数和重装         载值后，我们就可以知道看门狗的喂狗时间（也就是看门狗溢出时间），该时间的计算方式为：

![屏幕截图 2024 09 12 111719](https://img.picgo.net/2024/09/12/-2024-09-12-111719a66fd3f005548f55.png)

其中 Tout 为看门狗溢出时间（单位为 ms）； prer 为看门狗时钟预分频值（IWDG_PR 值），范围为 0~7； rlr 为看门狗的重装载值（IWDG_RLR 的值）；

比如我们设定 prer 值为 4（ 4 代表的是 64 分频， HAL 库中可以使用宏定义标识符IWDG_PRESCALER_64）， rlr 值为 500，那么就可以得到 Tout=64× 500/32=1000ms，这样，看门狗的溢出时间就是 1s，只要你在一秒钟之内，有一次写入 0XAAAA 到 IWDG_KR，就不会导致看门狗复位（当然写入多次也是可以的）。这里需要提醒大家的是，看门狗的时钟不是准确的 32Khz，所以在喂狗的时候，最好不要太晚了，否则，有可能发生看门狗复位。

### 3.2 重载计数值喂狗（向IWDG_KR写入0xAAAA）

在 HAL 中重载计数值的函数是 HAL_IWDG_Refresh，该函数声明为：

```c
HAL_StatusTypeDef HAL_IWDG_Refresh(IWDG_HandleTypeDef *hiwdg);
```

该函数有一个入口参数为前面讲解的 IWDG_HandleTypeDef 结构体类型指针，它的作用是把值0xAAAA写入到IWDG_KR寄存器，从而触发计数器重载， 即实现独立看门狗的喂狗操作。

### 3.3 启动看门狗（向IWDG_KR写入0xCCCC）

HAL 库函数里面启动独立看门狗的函数是 HAL_IWDG_Start：

```c
HAL_StatusTypeDef HAL_IWDG_Start(IWDG_HandleTypeDef *hiwdg);
```

通过上面 3 个步骤，我们就可以启动 STM32F4 的独立看门狗了，使能了看门狗，在程序里面就必须间隔一定时间喂狗，否则将导致程序复位。利用这一点，我们本章将通过一个 LED灯来指示程序是否重启，来验证 STM32F4 的独立看门狗。

在配置看门狗后， DS0 将常亮，如果 KEY_UP 按键按下，就喂狗，只要 KEY_UP 不停的按，看门狗就一直不会产生复位，保持 DS0 的常亮，一旦超过看门狗定溢出时间（Tout）还没按，那么将会导致程序重启，这将导致 DS0 熄灭一次。

---

2024.9.29 第一次修订，后期不再维护

# 第二章 程序下载与调试

## 1. STM32串口程序下载

STM32F4 的程序下载有多种方法： USB、串口、 JTAG、 SWD 等，这几种方式，都可以用来给 STM32F4 下载代码。不过，最简单也是最经济的，就是通过串口给 STM32F4 下载代码。本节，我们将向大家介绍，如何利用串口给 STM32F4（以下简称 STM32）下载代码。

STM32 的串口下载一般是通过串口 1 下载的， 本手册的实验平台 ALIENTEK 探索者STM32F4 开发板，不是通过 RS232 串口下载的，而是通过自带的 USB 串口来下载。看起来像是 USB 下载（只需一根 USB 线，并不需要串口线）的，实际上，是通过 USB 转成串口，然后再下载的。

下面，我们就一步步教大家如何在实验平台上利用 USB 串口来下载代码。

首先要在板子上设置一下，在板子上把 RXD 和 PA9（STM32 的 TXD）， TXD 和 PA10(STM32的 RXD)通过跳线帽连接起来，这样我们就把 CH340G 和 MCU 的串口 1 连接上了。这里由于ALIENTEK 这款开发板自带了一键下载电路，所以我们并不需要去关心 BOOT0 和 BOOT1 的状态，但是为了让下下载完后可以按复位执行程序，我们建议大家把 BOOT1 和 BOOT0 都设置为 0。

![屏幕截图 2024 08 29 152502](https://img.picgo.net/2024/08/29/-2024-08-29-15250266a88901cd4eabeb.png)

这里简单说明一下一键下载电路的原理，我们知道， STM32 串口下载的标准方法是两个步骤：

1. 把B0按V3.3（保持B1接GND）

2. 按一下复位按键

通过这两个步骤，我们就可以通过串口下载代码了，下载完成之后，如果没有设置从0X08000000 开始运行，则代码不会立即运行，此时，你还需要把 B0 接回 GND，然后再按一次复位，才会开始运行你刚刚下载的代码。所以整个过程，你得跳动 2 次跳线帽，还得按 2 次复位，比较繁琐。而我们的一键下载电路，则利用串口的 DTR 和 RTS 信号，分别控制 STM32的复位和 B0，配合上位机软件（flymcu，即 mcuisp 的最新版本），设置： DTR 的低电平复位， RTS 高电平进 BootLoader，这样， B0 和 STM32 的复位，完全可以由下载软件自动控制，从而实现一键下载。

接着我们在 USB_232 处插入 USB 线， 并接上电脑， 如果之前没有安装 CH340G 的驱动（如果已经安装过了驱动，则应该能在设备管理器里面看到 USB 串口，如果不能则要先卸载之前的驱动，卸载完后重启电脑，再重新安装我们提供的驱动），则需要先安装 CH340G 的驱动：

![](C:\Users\qiu\AppData\Roaming\marktext\images\2024-08-29-15-28-20-image.png)

在驱动安装成功之后，拔掉 USB 线，然后重新插入电脑，此时电脑就会自动给其安装驱动了。在安装完成之后，可以在电脑的设备管理器里面找到 USB 串口（如果找不到，则重启下电脑）

![](C:\Users\qiu\AppData\Roaming\marktext\images\2024-08-29-15-29-00-image.png)

可以看到，我们的 USB 串口被识别为 COM3，这里需要注意的是：不同电脑可能不一样，你的可能是 COM4、 COM5 等，但是 USB-SERIAL CH340，这个一定是一样的。如果没找到 USB 串口，则有可能是你安装有误，或者系统不兼容。

## 2. STLINK下载与调试程序

上一节，我们介绍了如何通过利用串口给 STM32 下载代码，并在 ALIENTEK 探索者STM32F4 开发板上验证了我们程序的正确性。 这个代码比较简单，所以不需要硬件调试，我们直接就一次成功了。可是，如果你的代码工程比较大，难免存在一些 bug，这时，就有必要通过硬件调试来解决问题了。

串口只能下载代码，并不能实时跟踪调试，而利用调试工具，比如 JLINK、 ULINK、 STLINK等就可以实时跟踪程序，从而找到你程序中的 bug，使你的开发事半功倍。这里我们以 STLINK为例，说说如何在线调试 STM32F4。

STLINK 支持 JTAG 和 SWD，同时 STM32 也支持 JTAG 和 SWD。所以，我们有 2 种方式可以用来调试， JTAG 调试的时候，占用的 IO 线比较多，而 SWD 调试的时候占用的 IO 线很少，只需要两根即可。

首先，用 STLINK 进行下载与调试，大家要在硬件上，把 STLINK 用 USB 线连接到电脑usb 和板子的 JTAG 接口上。

STLINK 的驱动安装比较简单，我们在这里就不说了。在安装了 STLINK 的驱动之后，我们接上 STLINK，并把 JTAG 口插到探索者 STM32 开发板上，打开 Options for Target 选项卡，在 Debug 栏选择仿真工具为 ST-LINK Debugger：

![屏幕截图 2024 08 29 153755](https://img.picgo.net/2024/08/29/-2024-08-29-1537555490eedef9f5f32e.png)

上图中我们还勾选了 Run to main()，该选项选中后，只要点击仿真就会直接运行到 main 函数，如果没选择这个选项，则会先执行 startup_stm32f40_41xxx.s 文件的 Reset_Handler，再跳到main 函数。

然后我们点击 Settings，设置 STLINK 的一些参数：

![屏幕截图 2024 08 29 153938](https://img.picgo.net/2024/08/29/-2024-08-29-153938d6b9297561b46511.png)

我们使用 STLINK 的 SW 模式调试，因为我们 JTAG 需要占用比 SW 模式多很多的 IO 口，而在探索者 STM32 开发板上这些 IO 口可能被其他外设用到，可能造成部分外设无法使用。所以，我们建议大家在调试的时候，一定要选择 SW 模式。Max Clock，可以点击 Auto Clk 来自动设置，图中我们设置 SWD 的调试速度为 4MHz，这里，如果你的 USB数据线比较差，那么可能会出问题，此时，你可以通过降低这里的速率来试试。

单击 OK，完成此部分设置，接下来我们还需要在 Utilities 选项卡里面设置下载时的目标编程器：

![屏幕截图 2024 08 29 154116](https://img.picgo.net/2024/08/29/-2024-08-29-154116d68aa2b2946d3164.png)

我们直接勾选 Use Debug Driver，即和调试一样，选择 STLINK 来给目标器件的 FLASH 编程，然后点击 Settings：

![](C:\Users\qiu\AppData\Roaming\marktext\images\2024-08-29-15-45-13-image.png)

这里 MDK5 会根据我们新建工程时选择的目标器件，自动设置 flash 算法。我们使用的是STM32F407ZGT6， FLASH 容量为 1M 字节，所以 Programming Algorithm 里面默认会有 1M 型号的 STM32F4xx FLASH 算法。 特别提醒： 这里的 1M flash 算法，不仅仅针对 1M 容量的STM32F4，对于小于 1M FLASH 的型号，也是采用这个 flash 算法的。最后，选中 Reset and Run选项，以实现在编程后自动运行，其他默认设置即可。

在设置完之后，点击 OK，然后再点击 OK，回到 IDE 界面，编译一下工程。 接下来我们就可以通过 STLINK 下载代码和调试代码。

配置好 STLINK 之后，使用 STLINK 下载代码就非常简单，大家只需要点击 LOAD 按钮就可以进行程序下载。下载完成之后程序就可以直接在开发板执行。

![](C:\Users\qiu\AppData\Roaming\marktext\images\2024-08-29-15-46-05-image.png)
